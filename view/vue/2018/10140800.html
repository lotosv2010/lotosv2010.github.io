<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue源码分析(十四) 编译之codegen | 码农沉思录</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.jpg">
    <meta name="description" content="代码千万行, 注释第一行, 编码不规范, 同事两行泪">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.92019516.css" as="style"><link rel="preload" href="/assets/js/app.ad2c5d61.js" as="script"><link rel="preload" href="/assets/js/4.82f582a9.js" as="script"><link rel="preload" href="/assets/js/1.72e48573.js" as="script"><link rel="preload" href="/assets/js/55.a7716bd5.js" as="script"><link rel="prefetch" href="/assets/js/10.6bbbb4af.js"><link rel="prefetch" href="/assets/js/11.84886e2e.js"><link rel="prefetch" href="/assets/js/12.6ab8637d.js"><link rel="prefetch" href="/assets/js/13.ea9ef3eb.js"><link rel="prefetch" href="/assets/js/14.865dcee3.js"><link rel="prefetch" href="/assets/js/15.49d2e55e.js"><link rel="prefetch" href="/assets/js/16.0b37b058.js"><link rel="prefetch" href="/assets/js/17.e5cd5fdd.js"><link rel="prefetch" href="/assets/js/18.85dd604a.js"><link rel="prefetch" href="/assets/js/19.f588c03c.js"><link rel="prefetch" href="/assets/js/20.33d127dd.js"><link rel="prefetch" href="/assets/js/21.2726927d.js"><link rel="prefetch" href="/assets/js/22.95f3f4a3.js"><link rel="prefetch" href="/assets/js/23.d8a538a6.js"><link rel="prefetch" href="/assets/js/24.17ad2529.js"><link rel="prefetch" href="/assets/js/25.f51b2675.js"><link rel="prefetch" href="/assets/js/26.934ec669.js"><link rel="prefetch" href="/assets/js/27.72508c77.js"><link rel="prefetch" href="/assets/js/28.2b0959c4.js"><link rel="prefetch" href="/assets/js/29.1c963303.js"><link rel="prefetch" href="/assets/js/30.8e399044.js"><link rel="prefetch" href="/assets/js/31.e4928ff3.js"><link rel="prefetch" href="/assets/js/32.c6b6ef8d.js"><link rel="prefetch" href="/assets/js/33.ddfa1e4c.js"><link rel="prefetch" href="/assets/js/34.3e4256dd.js"><link rel="prefetch" href="/assets/js/35.8a92b27b.js"><link rel="prefetch" href="/assets/js/36.4167114e.js"><link rel="prefetch" href="/assets/js/37.11de70c3.js"><link rel="prefetch" href="/assets/js/38.51bfcef9.js"><link rel="prefetch" href="/assets/js/39.391d16d4.js"><link rel="prefetch" href="/assets/js/40.75c9b958.js"><link rel="prefetch" href="/assets/js/41.adff1d44.js"><link rel="prefetch" href="/assets/js/42.b18f2f3c.js"><link rel="prefetch" href="/assets/js/43.39857e56.js"><link rel="prefetch" href="/assets/js/44.8d646eb3.js"><link rel="prefetch" href="/assets/js/45.8696e081.js"><link rel="prefetch" href="/assets/js/46.6b1aef3a.js"><link rel="prefetch" href="/assets/js/47.6c8a36c8.js"><link rel="prefetch" href="/assets/js/48.c54441d1.js"><link rel="prefetch" href="/assets/js/49.902cc547.js"><link rel="prefetch" href="/assets/js/5.ebb7f635.js"><link rel="prefetch" href="/assets/js/50.b6dd2518.js"><link rel="prefetch" href="/assets/js/51.ebec3ecf.js"><link rel="prefetch" href="/assets/js/52.5a757ff9.js"><link rel="prefetch" href="/assets/js/53.381b38f6.js"><link rel="prefetch" href="/assets/js/54.5a34c05b.js"><link rel="prefetch" href="/assets/js/56.30b8e2e3.js"><link rel="prefetch" href="/assets/js/57.079ff0b7.js"><link rel="prefetch" href="/assets/js/58.23b4a501.js"><link rel="prefetch" href="/assets/js/59.f41538da.js"><link rel="prefetch" href="/assets/js/6.d3a9d217.js"><link rel="prefetch" href="/assets/js/60.8801415c.js"><link rel="prefetch" href="/assets/js/61.296117b6.js"><link rel="prefetch" href="/assets/js/62.0380b2ff.js"><link rel="prefetch" href="/assets/js/63.4e82cbaa.js"><link rel="prefetch" href="/assets/js/7.6156d368.js"><link rel="prefetch" href="/assets/js/8.1c82c0e7.js"><link rel="prefetch" href="/assets/js/9.3648f843.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.83298789.js">
    <link rel="stylesheet" href="/assets/css/0.styles.92019516.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>码农沉思录</h3> <p class="description" data-v-59e6cb88>代码千万行, 注释第一行, 编码不规范, 同事两行泪</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Robin</span>
          
        <span data-v-59e6cb88>2015 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.jpg" alt="码农沉思录" class="logo"> <span class="site-name">码农沉思录</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/css系统梳理/" class="nav-link"><i class="undefined"></i>
  css系统梳理
</a></li><li class="dropdown-item"><!----> <a href="/categories/css响应式/" class="nav-link"><i class="undefined"></i>
  css响应式
</a></li><li class="dropdown-item"><!----> <a href="/categories/简历/" class="nav-link"><i class="undefined"></i>
  简历
</a></li><li class="dropdown-item"><!----> <a href="/categories/ES系统梳理/" class="nav-link"><i class="undefined"></i>
  ES系统梳理
</a></li><li class="dropdown-item"><!----> <a href="/categories/html5系统梳理/" class="nav-link"><i class="undefined"></i>
  html5系统梳理
</a></li><li class="dropdown-item"><!----> <a href="/categories/js基础/" class="nav-link"><i class="undefined"></i>
  js基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/js面试题/" class="nav-link"><i class="undefined"></i>
  js面试题
</a></li><li class="dropdown-item"><!----> <a href="/categories/jquery源码分析/" class="nav-link"><i class="undefined"></i>
  jquery源码分析
</a></li><li class="dropdown-item"><!----> <a href="/categories/PMP考试每日一题/" class="nav-link"><i class="undefined"></i>
  PMP考试每日一题
</a></li><li class="dropdown-item"><!----> <a href="/categories/react源码分析/" class="nav-link"><i class="undefined"></i>
  react源码分析
</a></li><li class="dropdown-item"><!----> <a href="/categories/软考高级每日三题/" class="nav-link"><i class="undefined"></i>
  软考高级每日三题
</a></li><li class="dropdown-item"><!----> <a href="/categories/软考高级解锁打卡/" class="nav-link"><i class="undefined"></i>
  软考高级解锁打卡
</a></li><li class="dropdown-item"><!----> <a href="/categories/软考高级日历打卡/" class="nav-link"><i class="undefined"></i>
  软考高级日历打卡
</a></li><li class="dropdown-item"><!----> <a href="/categories/vue源码分析/" class="nav-link"><i class="undefined"></i>
  vue源码分析
</a></li><li class="dropdown-item"><!----> <a href="/categories/webpack前端工程化/" class="nav-link"><i class="undefined"></i>
  webpack前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/categories/聚焦Vue、React、Webpack/" class="nav-link"><i class="undefined"></i>
  聚焦Vue、React、Webpack
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      FriendLink
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lotosv2010/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.cnblogs.com/lotosv2010/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bokeyuan"></i>
  博客圆
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/lotosv2010" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-document"></i>
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/head.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Robin
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>49</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>14</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/css系统梳理/" class="nav-link"><i class="undefined"></i>
  css系统梳理
</a></li><li class="dropdown-item"><!----> <a href="/categories/css响应式/" class="nav-link"><i class="undefined"></i>
  css响应式
</a></li><li class="dropdown-item"><!----> <a href="/categories/简历/" class="nav-link"><i class="undefined"></i>
  简历
</a></li><li class="dropdown-item"><!----> <a href="/categories/ES系统梳理/" class="nav-link"><i class="undefined"></i>
  ES系统梳理
</a></li><li class="dropdown-item"><!----> <a href="/categories/html5系统梳理/" class="nav-link"><i class="undefined"></i>
  html5系统梳理
</a></li><li class="dropdown-item"><!----> <a href="/categories/js基础/" class="nav-link"><i class="undefined"></i>
  js基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/js面试题/" class="nav-link"><i class="undefined"></i>
  js面试题
</a></li><li class="dropdown-item"><!----> <a href="/categories/jquery源码分析/" class="nav-link"><i class="undefined"></i>
  jquery源码分析
</a></li><li class="dropdown-item"><!----> <a href="/categories/PMP考试每日一题/" class="nav-link"><i class="undefined"></i>
  PMP考试每日一题
</a></li><li class="dropdown-item"><!----> <a href="/categories/react源码分析/" class="nav-link"><i class="undefined"></i>
  react源码分析
</a></li><li class="dropdown-item"><!----> <a href="/categories/软考高级每日三题/" class="nav-link"><i class="undefined"></i>
  软考高级每日三题
</a></li><li class="dropdown-item"><!----> <a href="/categories/软考高级解锁打卡/" class="nav-link"><i class="undefined"></i>
  软考高级解锁打卡
</a></li><li class="dropdown-item"><!----> <a href="/categories/软考高级日历打卡/" class="nav-link"><i class="undefined"></i>
  软考高级日历打卡
</a></li><li class="dropdown-item"><!----> <a href="/categories/vue源码分析/" class="nav-link"><i class="undefined"></i>
  vue源码分析
</a></li><li class="dropdown-item"><!----> <a href="/categories/webpack前端工程化/" class="nav-link"><i class="undefined"></i>
  webpack前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/categories/聚焦Vue、React、Webpack/" class="nav-link"><i class="undefined"></i>
  聚焦Vue、React、Webpack
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      FriendLink
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lotosv2010/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.cnblogs.com/lotosv2010/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bokeyuan"></i>
  博客圆
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/lotosv2010" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-document"></i>
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>vue源码分析(十四) 编译之codegen</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Robin</span>
          
        <span data-v-59e6cb88>2015 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">vue源码分析(十四) 编译之codegen</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Robin</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>10/14/2018</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>vue</span><span class="tag-item" data-v-8a445198>源码分析</span><span class="tag-item" data-v-8a445198>面试</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1. 概述</h2> <p>​	我们知道编译总共有三个过程， 即<code>parse</code>、<code>optimize</code>和 <code>codegen</code>，前面几章我们已经分析了解析和优化两个过程，接下来我们分析编译的最后一个过程就是把优化后的 <code>AST</code> 树转换成可执行的代码，在分析前我们还是以一个 <code>case</code> 进行讲解。</p> <p>​	案例如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classObject<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isShow<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(l, i) in list<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>i<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>i<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clickItem(index)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ i }}:{{ l }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​	这段模板经过解析和优化两个过程生成的 <code>AST</code> 树如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">attrsList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">attrsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;classObject&quot;</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token string">&quot;l&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attrsList</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;@click&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;clickItem(index)&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">109</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">134</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attrsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">:</span> <span class="token string">&quot;(l, i) in list&quot;</span><span class="token punctuation">,</span> <span class="token operator">:</span>key<span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> @click<span class="token operator">:</span> <span class="token string">&quot;clickItem(index)&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
          <span class="token literal-property property">expression</span><span class="token operator">:</span> <span class="token string">&quot;_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l)&quot;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">135</span><span class="token punctuation">,</span>
          <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&quot;{{ i }}:{{ l }}&quot;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">tokens</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>@binding<span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>@binding<span class="token operator">:</span> <span class="token string">&quot;l&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">155</span><span class="token punctuation">,</span>
      <span class="token literal-property property">events</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">click</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;clickItem(index)&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">dynamic</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">109</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">134</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">for</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">hasBindings</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">iterator1</span><span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">/* 省略... ul */</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">plain</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">rawAttrsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token operator">:</span>key<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;:key&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
				@click<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;@click&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;clickItem(index)&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">109</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">134</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;ref&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">108</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
				v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;v-for&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;(l, i) in list&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">69</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">91</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>i<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">refInFor</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
      <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">staticRoot</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">classBinding</span><span class="token operator">:</span> <span class="token string">&quot;classObject&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">171</span><span class="token punctuation">,</span>
  <span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">ifConditions</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{</span>
       <span class="token literal-property property">exp</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">,</span> 
       <span class="token literal-property property">block</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token literal-property property">attrsList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token literal-property property">attrsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;classObject&quot;</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">/* 省略... li */</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token literal-property property">classBinding</span><span class="token operator">:</span> <span class="token string">&quot;classObject&quot;</span><span class="token punctuation">,</span>
         <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">171</span><span class="token punctuation">,</span>
         <span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">,</span>
         <span class="token literal-property property">ifConditions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">/* 省略... ul */</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
         <span class="token literal-property property">plain</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
         <span class="token literal-property property">rawAttrsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
           <span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;:class&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;classObject&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          	<span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          	v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;v-if&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">51</span><span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
         <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
         <span class="token literal-property property">staticClass</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>list<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
         <span class="token literal-property property">staticRoot</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
         <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span>
         <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">1</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plain</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">rawAttrsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;:class&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;classObject&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;v-if&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">51</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">staticClass</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>list<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">staticRoot</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;ul&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><p>​	接下来我们就看 vue 是如何将这样的一个 AST 树生成一个 <code>render</code> 函数代码的。</p> <h2 id="_2-generate"><a href="#_2-generate" class="header-anchor">#</a> 2. generate</h2> <p>​	我们在 <strong><a href="https://lotosv2010.github.io/view/vue/2018/10080800.html#_4-3-basecompile" target="_blank" rel="noopener noreferrer">vue源码分析(八) 编译之整体流程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> 中分析过了编译的三个过程，即解析模板字符串生成 <code>AST</code>、优化语法树、生成代码，生成代码的过程是通过调用 <code>generate</code> 函数实现的，我们先来看一下它的定义，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generate</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">ast</span><span class="token operator">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodegenState</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'_c(&quot;div&quot;)'</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> state<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>​	从上面的源码我们可以知道，<code>generate</code> 首先通过 <code>new</code> 创建一个 <code>CodegenState</code> 实例，接着通过 <code>genElement</code> 将 <code>ast</code> 对象转换为字符串。</p> <p>​	接下来我们分别来分析这两个过程。</p> <h2 id="_3-codegenstate"><a href="#_3-codegenstate" class="header-anchor">#</a> 3. CodegenState</h2> <p>​	首先我们看一下 <code>CodegenState</code> 的定义，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CodegenState</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions<span class="token punctuation">;</span>
  <span class="token literal-property property">warn</span><span class="token operator">:</span> Function<span class="token punctuation">;</span>
  <span class="token literal-property property">transforms</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>TransformFunction<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token literal-property property">dataGenFns</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>DataGenFunction<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> DirectiveFunction <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function-variable function">maybeComponent</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean<span class="token punctuation">;</span>
  <span class="token literal-property property">onceId</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token literal-property property">pre</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
    <span class="token keyword">this</span><span class="token punctuation">.</span>warn <span class="token operator">=</span> options<span class="token punctuation">.</span>warn <span class="token operator">||</span> baseWarn
    <span class="token keyword">this</span><span class="token punctuation">.</span>transforms <span class="token operator">=</span> <span class="token function">pluckModuleFunction</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token string">'transformCode'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dataGenFns <span class="token operator">=</span> <span class="token function">pluckModuleFunction</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token string">'genData'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> baseDirectives<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>directives<span class="token punctuation">)</span>
    <span class="token keyword">const</span> isReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">maybeComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token operator">!</span>el<span class="token punctuation">.</span>component <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onceId <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pre <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>​	<code>CodegenState</code> 是根据 <code>options</code> 创建的对象，这里的 <code>options</code> 的值为，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">comments</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">delimiters</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">outputSourceRange</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shouldDecodeNewlines</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shouldDecodeNewlinesForHref</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">warn</span><span class="token operator">:</span> <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> range<span class="token punctuation">,</span> tip<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
  <span class="token literal-property property">__proto__</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">canBeLeftOpenTag</span><span class="token operator">:</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token function">model</span><span class="token punctuation">(</span> <span class="token parameter">el<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> _warn</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">expectHTML</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">getTagNamespace</span><span class="token operator">:</span> <span class="token function">getTagNamespace</span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isPreTag</span><span class="token operator">:</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isReservedTag</span><span class="token operator">:</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isUnaryTag</span><span class="token operator">:</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">genData</span><span class="token operator">:</span> <span class="token function">genData</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">staticKeys</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;staticClass&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transformNode</span><span class="token operator">:</span> <span class="token function">transformNode</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">genData</span><span class="token operator">:</span> <span class="token function">genData$1</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">staticKeys</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;staticStyle&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transformNode</span><span class="token operator">:</span> <span class="token function">transformNode$1</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">preTransformNode</span><span class="token operator">:</span> <span class="token function">preTransformNode</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  	<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mustUseProp</span><span class="token operator">:</span> <span class="token punctuation">(</span>tag<span class="token punctuation">,</span> type<span class="token punctuation">,</span> attr<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">staticKeys</span><span class="token operator">:</span> <span class="token string">&quot;staticClass,staticStyle&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>​	所以根据 <code>options</code> 通过 <code>new</code> 创建的对象实例为，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">dataGenFns</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">genData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token function">genData$</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
	<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bind</span><span class="token operator">:</span> <span class="token function">bind$1</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cloak</span><span class="token operator">:</span> <span class="token function">noop</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token function">model</span><span class="token punctuation">(</span> <span class="token parameter">el<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> _warn</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maybeComponent</span><span class="token operator">:</span> <span class="token function">ƒ</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">onceId</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">/* 省略... */</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 同上</span>
  <span class="token literal-property property">pre</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">staticRenderFns</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">transforms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">warn</span><span class="token operator">:</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> range<span class="token punctuation">,</span> tip</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>​	接下来我们分一下 <code>CodegenState</code> 实例的每个属性的作用：</p> <ul><li><code>options</code> : 缓存实例化传递进来的 <code>options</code></li> <li><code>warn</code> : 用来打印警告信息的</li> <li><code>transforms</code> : 空数组</li> <li><code>dataGenFns</code> : 对静态类和静态样式的处理</li> <li><code>directives</code> : 对指令的相关操作</li> <li><code>isReservedTag</code> : 保留标签标志</li> <li><code>maybeComponent</code> : 判断是组件</li> <li><code>onceId</code> : 使用<code>v-once</code>的递增id</li> <li><code>staticRenderFns</code> : 对静态根节点的处理</li> <li><code>pre</code> : <code>v-pre</code> 标识</li></ul> <div class="custom-block danger"><p class="title"></p><p>注意：关于 <code>pluckModuleFunction</code> 和 <code>options.modules</code> 我们在 <a href="https://lotosv2010.github.io/view/vue/2018/10110800.html#_5-1-%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer"><strong>vue源码分析(十一) 编译之解析(parse)——parse</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中已经分析过了。</p></div><h2 id="_4-整体流程"><a href="#_4-整体流程" class="header-anchor">#</a> 4. 整体流程</h2> <p>​	我们先以上面的案例来分析，代码生成的整个流程，通过分析 <code>generate</code>我们知道代码生成是通过 <code>genElement</code> 函数将 <code>ast</code> 对象转换为字符串，接下来我们从 <code>genElement</code> 函数来开始分析。</p> <h3 id="_4-1-genelement"><a href="#_4-1-genelement" class="header-anchor">#</a> 4.1 genElement</h3> <p>​	我们首先看一下 <code>genElement</code> 的定义，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 将ast对象转换为字符串
 * @param {ast树} el 
 * @param {CodegenState 实例} state 
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genElement</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">state</span><span class="token operator">:</span> CodegenState</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>pre <span class="token operator">=</span> el<span class="token punctuation">.</span>pre <span class="token operator">||</span> el<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pre
  <span class="token punctuation">}</span>
  <span class="token comment">// 对一些标签属性的处理</span>
  <span class="token comment">// 处理静态树节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>staticProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genStatic</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>onceProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 v-once 节点</span>
    <span class="token keyword">return</span> <span class="token function">genOnce</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>forProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 v-for 节点</span>
    <span class="token keyword">return</span> <span class="token function">genFor</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>ifProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 v-if 节点</span>
    <span class="token keyword">return</span> <span class="token function">genIf</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>slotTarget <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 template 节点</span>
    <span class="token keyword">return</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'void 0'</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'slot'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理 slot 节点</span>
    <span class="token keyword">return</span> <span class="token function">genSlot</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// component or element</span>
    <span class="token comment">// 处理组件 或 元素节点</span>
    <span class="token keyword">let</span> code
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理组件节点</span>
      code <span class="token operator">=</span> <span class="token function">genComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">,</span> el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//核心的body部分</span>
      <span class="token keyword">let</span> data
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>plain <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>pre <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1、生成节点的数据对象data的字符串</span>
        data <span class="token operator">=</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 2、查找其子节点,生成子节点的字符串</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>inlineTemplate <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token comment">// 3、将tag，data，children拼装成字符串</span>
      code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        data <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// data</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// children</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// module transforms</span>
    <span class="token comment">// 循环执行 state.transforms 数组中的 genData 函数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">=</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> code
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>​	我们案例中跟节点为 <code>ul</code> ，属性有<code>:class: &quot;classObject&quot;</code>、 <code>class: &quot;list&quot;</code>、 <code>v-if: &quot;isShow&quot;</code> 所以代码会执行到 <code>genIf</code> 如下语句：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token function">genIf</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4-2-genif"><a href="#_4-2-genif" class="header-anchor">#</a> 4.2 genIf</h3> <p>​	接下来我们看看 <code>genIf</code> 的定义，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genIf</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> CodegenState<span class="token punctuation">,</span>
  altGen<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  altEmpty<span class="token operator">?</span><span class="token operator">:</span> string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  el<span class="token punctuation">.</span>ifProcessed <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// avoid recursion</span>
  <span class="token keyword">return</span> <span class="token function">genIfConditions</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> altGen<span class="token punctuation">,</span> altEmpty<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>​	<code>genIf</code>  的逻辑很简单，主要是通过执行 <code>genIfConditions</code> ，处理 <code>v-if/v-else-if/v-else</code>  指令所对应的 <code>AST</code> 节点。</p> <h3 id="_4-3-genifconditions"><a href="#_4-3-genifconditions" class="header-anchor">#</a> 4.3 genIfConditions</h3> <p>​	接下来我们看看 <code>genIfConditions</code> 的逻辑，首先是判断 <code>AST</code> 树的  <code>conditions</code> 数组是否有值，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genIfConditions</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">conditions</span><span class="token operator">:</span> ASTIfConditions<span class="token punctuation">,</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> CodegenState<span class="token punctuation">,</span>
  altGen<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  altEmpty<span class="token operator">?</span><span class="token operator">:</span> string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>conditions<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> altEmpty <span class="token operator">||</span> <span class="token string">'_e()'</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* 省略... */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>​	我们通过源码可以知道如果 <code>conditions</code> 数组为空，则返回一个生成空的虚拟 <code>dom</code> 的函数字符串；如果<code>conditions</code> 数组不为空，代码继续往下执行，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> condition <span class="token operator">=</span> conditions<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">.</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>condition<span class="token punctuation">.</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  <span class="token function">genTernaryExp</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span>block<span class="token punctuation">)</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  <span class="token function">genIfConditions</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> state<span class="token punctuation">,</span> altGen<span class="token punctuation">,</span> altEmpty<span class="token punctuation">)</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genTernaryExp</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span>block<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>​	当 <code>conditions</code> 数组不为空时，首先取第一个元素赋值给变量 <code>condition</code>，在我们当前案例中，我们知道 <code>conditions</code> 为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">exp</span><span class="token operator">:</span> <span class="token string">&quot;isShow&quot;</span><span class="token punctuation">,</span> 
    <span class="token literal-property property">block</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">/* 省略，ul节点生成的AST树 */</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>​	所以接下来的 <code>if</code> 条件 <code>condition.exp</code> 为 <code>true</code> 继续执行  <code>if</code> 语句块，而此处的 <code>else</code> 语句块是 <code>conditions</code> 中 <code>v-else</code> 对应的 <code>AST</code> 树执行的逻辑，在我们当前案例中不会执行<code>else</code> 语句块。</p> <p>​	<code>if</code> 语句块的作用是调用 <code>genIfConditions</code> 进行递归生成二元表达式。我们从源码可以得到二元表达式的条件为 <code>condition.exp</code> 第一个表达式为 <code>genTernaryExp(condition.block)</code> 第二个表达式为 <code>genIfConditions(conditions, state, altGen, altEmpty)</code>，我们接下来看看  <code>genTernaryExp</code> 的定义如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// v-if with v-once should generate code like (a)?_m(0):_m(1)</span>
<span class="token keyword">function</span> <span class="token function">genTernaryExp</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> altGen
    <span class="token operator">?</span> <span class="token function">altGen</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token operator">:</span> el<span class="token punctuation">.</span>once
    <span class="token operator">?</span> <span class="token function">genOnce</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">genElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>​	<code>genTernaryExp</code> 函数里面主要是一个多元的表达式，首先判断 <code>altGen</code> 如果存在，则返回调用<code>altGen(el, state)</code> 执行的结果，如果不存在接着判断当前 <code>AST</code> 树是否使用了 <code>v-once</code> 指令即判断 <code>el.once</code> 属性是否存在，如果存在则返回调用<code>genOnce(el, state)</code> 执行的结果，即返回一个创建静态标签节点的函数的字符，如果不存在则继续回调 <code>genElement(el, state)</code> 生成节点的字符串。</p> <p>​	在我们当前案例中，会执行 <strong><code>genElement(el, state)</code></strong> 。<code>genElement</code> 我们前面已经分析过了，这次执行 <code>genElement</code> 时，由于我们在 <code>genIf</code> 给 <code>AST</code> 树添加了 <code>el.ifProcessed = true</code> ，所以这次执行 <code>genElement</code> 将不会在执行到 <code>genIf</code> 对应的 <code>if</code> 语句块，而是 执行 <code>else</code> 语句，我们再来回顾一下 <code>genElement</code> 的  <code>else</code> 语句块，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// component or element</span>
<span class="token keyword">let</span> code
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  code <span class="token operator">=</span> <span class="token function">genComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">,</span> el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>plain <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>pre <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>inlineTemplate <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  
  code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  	data <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// data</span>
	<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  	children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// children</span>
	<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// module transforms</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  code <span class="token operator">=</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> code
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>​	从源码我们可以知道 <code>else</code> 语句块主要是对组件和元素进行处理生成 <code>render</code> 表达式字符串。</p> <p>​	这段代码首先定义一个变量 <code>code</code> 用来保存最终生成 <code>render</code> 表达式字符串，接下来是一个 <code>if...else</code> 语句块，其中 <code>if</code> 语句块只要是对组件的处理，<code>else</code> 语句块是对普通元素的处理，在我们这个案例中会执行到<code>else</code> 语句块，首先会判断当前标签是不否存在 <code>plain</code> 属性或者存在 <code>pre</code>属性并且是组件，则会执行 <code>if</code> 语句，此时我们 <code>AST</code> 树没有 <code>plain</code> 属性，所以会调用  <code>genData</code> 函数生成节点的数据对象 <code>data</code> 的字符串。</p> <p>​	接下来通过判断标签是不是内联模板则返回 <code>null</code> ，如果不是内联模板则直接调用 <code>genChildren</code>，查找其子节点，生成子节点的字符串。</p> <p>​	接着将 <code>tag</code>，<code>data</code>，<code>children</code> 拼装成字符串，赋值给 <code>code</code>。</p> <p>​	最后通过循环 <code>state.transforms</code> 数组，执行数组中的每个函数，我们在前面分析此案例生成的 <code>AST</code>  树的时候知道 <code>state.transforms</code> 是通过 <code>this.transforms = pluckModuleFunction(options.modules, 'transformCode')</code> 这句生成的，此时的 <code>state.transforms</code> 为空，所以不会执行循环里面的代码，最后直接返回 <code>code</code>。</p> <div class="custom-block tip"><p class="title"></p><p>说明：关于 <code>el.plain</code> 我们在 <a href="https://lotosv2010.github.io/view/vue/2018/10120800.html#_2-16-processelement" target="_blank" rel="noopener noreferrer"><strong>vue源码分析(十二) 编译之解析(parse)——处理标签</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中已经做了详细的分析。</p> <p>​		   关于内联模板 <code>inline-template</code> ，可以查看 <a href="https://cn.vuejs.org/v2/guide/components-edge-cases.html#%E5%86%85%E8%81%94%E6%A8%A1%E6%9D%BF" target="_blank" rel="noopener noreferrer"><strong>这里</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p> <p>​		   关于 <code>pluckModuleFunction</code> 可以查看 <a href="https://lotosv2010.github.io/view/vue/2018/10110800.html#_5-1-%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer"><strong>这里</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div><div class="custom-block danger"><p class="title"></p><p>说明：关于 <code>genData</code>、<code>genChildren</code> 我们会在下面小节中做详细的分析。</p></div><h3 id="_4-4-gendata"><a href="#_4-4-gendata" class="header-anchor">#</a> 4.4 genData</h3> <p>​	接下我们看看 <code>genData</code> 的代码逻辑，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genData</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">state</span><span class="token operator">:</span> CodegenState</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">'{'</span>

  <span class="token comment">// directives first.</span>
  <span class="token comment">// directives may mutate the el's other properties before they are generated.</span>
  <span class="token keyword">const</span> dirs <span class="token operator">=</span> <span class="token function">genDirectives</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirs<span class="token punctuation">)</span> data <span class="token operator">+=</span> dirs <span class="token operator">+</span> <span class="token string">','</span>
  
  <span class="token comment">/* 省略... */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>​	<code>genData</code> 首先是定义一个 <code>data</code> 变量，用来存储生成节点的数据对象 <code>data</code> 的字符串，接下来调用 <code>genDirectives</code> 对 <code>directives</code> 进行处理将指令对象转换成一个字符串格式，例如 <code>&lt;div v-info&gt;&lt;/div&gt;</code>  则变成 <code>directives:[{name:&quot;info&quot;,rawName:&quot;v-info&quot;}]</code>。</p> <p>​	接下来判断获取到的指令字符串是否存在，如果存在则将获取的字符串追加到 <code>data</code> 变量并且已逗号结尾，如果不存在直接执行后续的代码。</p> <div class="custom-block danger"><p class="title"></p><p>说明：关于 <code>genDirectives</code>  我们会在下面小节中做详细的分析。</p></div><p>​	我们继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// key</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">key:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// ref</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ref:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>ref<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>refInFor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">refInFor:true,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// pre</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pre:true,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// record original tag name for components using &quot;is&quot; attribute</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">tag:&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>​	这段代码就是对一些属性的操作，<code>key</code>，<code>ref</code>，<code>refInFor</code>，<code>pre</code>，<code>tag</code> 纯粹将他们拼接起来，在我们的例子中， <code>ul AST</code> 元素节点这些属性值都是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	我们继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// module data generation functions</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>dataGenFns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> state<span class="token punctuation">.</span>dataGenFns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​	我们在前面的章节中分析知道 <code>pluckModuleFunction</code> 实际上就是获取所有 <code>modules</code> 中的 <code>genDatas</code> 函数，其中， <code>class module</code> 和 <code>style module</code>定义了 <code>genDatas</code> 函数。</p> <p>​	下面我们看看这两个 <code>genDatas</code> 函数。</p> <p>​	源码目录：<code>src/platforms/web/compiler/modules/class.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genData</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">staticClass:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>staticClass<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>classBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">class:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>classBinding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>​	源码目录：<code>src/platforms/web/compiler/modules/style.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genData</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">staticStyle:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>staticStyle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>styleBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">style:(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>styleBinding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">),</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>​	这个函数的逻辑一样，就是对静态属性 <code>class</code> 、<code>style</code> 和动态属性 <code>:class</code> 、<code>:style</code> 的处理，把处理结果值拼接起来返回。</p> <p>​	在我们的例子中， <code>ul AST</code> 元素节点定义了<code>el.staticClass</code> 和 <code>el.classBinding</code> ，因此最终生成的 <code>data</code> 字符串如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'staticClass:&quot;list&quot;,class:classObject,'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	我们再回到 <code>genData</code> 函数，继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// attributes</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">attrs:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genProps</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// DOM props</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">domProps:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genProps</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>​	这段代码是对普通属性和 <code>props</code>  属性进行处理，将结果追加到 <code>data</code> 变量并且已逗号结尾。同样在我们的例子中， <code>ul AST</code> 元素节点这些属性值都是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	我们继续往下看，接下来的代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// event handlers</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>​	这段代码是对原生事件和自定义事件进行处理，将结果追加到 <code>data</code> 变量并且已逗号结尾。同样在我们的例子中， <code>ul AST</code> 元素节点这些属性值都是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	我们继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// slot target</span>
<span class="token comment">// only for non-scoped slots</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>slotTarget <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>slotScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">slot:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>slotTarget<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// scoped slots</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>scopedSlots<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genScopedSlots</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> el<span class="token punctuation">.</span>scopedSlots<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>​	这段代码是对非作用域插槽和作用于插槽进行处理，将结果追加到 <code>data</code> 变量并且已逗号结尾。同样在我们的例子中， <code>ul AST</code> 元素节点这些属性值都是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	我们继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// component v-model</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">model:{value:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,callback:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>callback
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,expression:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  el<span class="token punctuation">.</span>model<span class="token punctuation">.</span>expression
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">},</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>​	这段代码是在组件上使用 <code>v-model</code> 指令的情况，对 <code>AST</code> 树的 <code>model</code> 属性进行处理，将结果追加到 <code>data</code> 变量并且已逗号结尾。</p> <p>​	例如：<code>v-model = &quot;name&quot;</code>，则转换的 <code>AST</code> 树为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token string">&quot;function ($$v) {name=$$v}&quot;</span><span class="token punctuation">,</span> 
  <span class="token literal-property property">expression</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>name<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> 
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;(name)&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>​	所有最终生成的字符串为，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'model:{value:(name),callback:function ($$v) {name=$$v},expression:&quot;name&quot;},'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	同样在我们的例子中， <code>ul AST</code> 元素节点这些属性值都是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	我们继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// inline-template</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>inlineTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inlineTemplate <span class="token operator">=</span> <span class="token function">genInlineTemplate</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inlineTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>inlineTemplate<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>​	这段代码是对内联模板的处理，将结果追加到 <code>data</code> 变量并且已逗号结尾。同样在我们的例子中， <code>ul AST</code> 元素节点这个属性值是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	我们继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">,$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'}'</span>
<span class="token comment">// v-bind dynamic argument wrap</span>
<span class="token comment">// v-bind with dynamic arguments must be applied using the same v-bind object</span>
<span class="token comment">// merge helper so that class/style/mustUseProp attrs are handled correctly.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>dynamicAttrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_b(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genProps</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>dynamicAttrs<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>​	这段代码首先通过 <code>replace</code> 替换，将最后一个逗号替换成空字符，并且在 <code>data</code> 字符串末尾添加一个 <code>}</code> 括号，接着判断<code>AST</code> 树是否存在动态属性，例如:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 动态参数的缩写 (2.6.0+) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">:[key]</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> ... <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​	转换的 <code>AST</code> 树为:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">dynamicAttrs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">dynamic</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">17</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>​	如果存在动态参数的属性，最终通过 <code>genProps</code> 处理，，将结果和 <code>data</code> 变量合并，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'_b({staticClass:&quot;list&quot;,class:classObject},&quot;ul&quot;,_d({},[val,name]))'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	同样在我们的例子中， <code>ul AST</code> 元素节点这个属性值是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	我们继续往下看，代码如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// v-bind data wrap</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>wrapData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">wrapData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// v-on data wrap</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>wrapListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">wrapListeners</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>​	<code>genData</code> 最后这两个 <code>if</code> 语句是对包装数据和包装事件进行处理，例如：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 绑定一个全是 attribute 的对象 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ id: someProp, 'other-attr': otherProp }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 对象语法 (2.4.0+) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">v-on</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ mousedown: doThis, mouseup: doThat }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>​	同样在我们的例子中， <code>ul AST</code> 元素节点这些属性值都是 <code>undefined</code> ，所以不会执行 <code>if</code> 中的语句 。</p> <p>​	至此我们把 <code>genData</code> 的业务逻辑已经分析完了，最后我们总结一下，<code>genData</code>的主要作用：</p> <ul><li>通过 <code>genDirectives</code> 对指令进行处理</li> <li>对一些属性的处理，包括 <code>key</code>，<code>ref</code>，<code>refInFor</code>，<code>pre</code>，<code>tag</code>，纯粹将他们拼接起来</li> <li>对静态属性 <code>class</code> 、<code>style</code> 和动态属性 <code>:class</code> 、<code>:style</code> 的处理</li> <li>通过 <code>genProps</code> 对<code>attrs</code>和<code>props</code> 属性进行处理</li> <li>通过 <code>genHandlers</code> 对自定义事件和原生事件进行处理</li> <li>对 <code>slot</code> 进行处理和通过 <code>genScopedSlots</code> 对作用于插槽进行处理</li> <li>对些属性 <code>v-model</code> 的处理</li> <li>通过 <code>genInlineTemplate</code> 内联模板 <code>inline-template</code> 进行处理</li> <li>对动态属性处理</li> <li><code>v-bind</code> 绑定的包装数据处理</li> <li><code>v-on</code> 绑定的包装事件处理</li></ul> <h3 id="_4-5-genchildren"><a href="#_4-5-genchildren" class="header-anchor">#</a> 4.5 genChildren</h3> <p>​	我们再回到 <code>genElement</code> 中的 <code>else</code>  语句块，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// component or element</span>
<span class="token keyword">let</span> data
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>plain <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>pre <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">=</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>inlineTemplate <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
	data <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// data</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
	children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// children</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>​	前面分析过了 <code>genData</code> ，接下通过判断内联模板是否存在，如果存在则 <code>children</code> 为空， 如果不存在则 <code>children</code> 为 <code>genChildren(el, state, true)</code> ，在我们当前案例中内联模板不存在所以执行 <code>genChildren</code> ，我们来看看 <code>genChildren</code> 的代码逻辑，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genChildren</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> CodegenState<span class="token punctuation">,</span>
  checkSkip<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  altGenElement<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  altGenNode<span class="token operator">?</span><span class="token operator">:</span> Function</span>
<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>children
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">el</span><span class="token operator">:</span> any <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// optimize single v-for</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      el<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span>
      el<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span>
      el<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'slot'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> normalizationType <span class="token operator">=</span> checkSkip
        <span class="token operator">?</span> state<span class="token punctuation">.</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,1</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,0</span><span class="token template-punctuation string">`</span></span>
        <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>altGenElement <span class="token operator">||</span> genElement<span class="token punctuation">)</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>normalizationType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> normalizationType <span class="token operator">=</span> checkSkip
      <span class="token operator">?</span> <span class="token function">getNormalizationType</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> state<span class="token punctuation">.</span>maybeComponent<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token keyword">const</span> gen <span class="token operator">=</span> altGenNode <span class="token operator">||</span> genNode
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">gen</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      normalizationType <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>normalizationType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>​	<code>genChildren</code> 首先获取子节点  <code>AST</code>  树赋值给 <code>children</code>，接下来判断 <code>children</code> 数组是否有值，如果有值，则继续执行下面逻辑：</p> <ul><li>对 <code>v-for</code> 进行简单优化</li> <li>对其他子节点进行处理</li></ul> <p>​	在们当前的案例中，此时的 <code>children</code> 为 <code>li AST</code>  树，因为 <code>li AST</code> 元素节点是 <code>ul AST</code> 元素节点的 <code>children</code> 之一，满足 <code>children.length === 1 &amp;&amp; el.for &amp;&amp; el.tag !== 'template' &amp;&amp; el.tag !== 'slot'</code> 条件，<code>if</code> 语句中先判断 <code>checkSkip</code>，如果为 <code>false</code>，<code>normalizationType = ''</code>, 如果为 <code>true</code>，再判断是不是组件，如果是则 <code>normalizationType = ',1'</code>, 否则 <code>normalizationType = ',0'</code>，最后返回 <code>genElement</code>  生成 <code>li AST</code> 元素节点的代码并拼接 <code>normalizationType</code> 的值。</p> <p>​	再回到了我们之前分析的 <code>genElement</code> 函数。此时会执行到下面的逻辑，如下：</p> <p>​      // 如果为 true，在判断是不是组件，如果是则 normalizationType = ',1', 否则 normalizationType = ',0' 因此通过 <code>genElement</code>  生成 <code>li AST</code> 元素节点的代码，也就回到了我们之前分析的 <code>genElement</code> 函数。此时会执行到下面的逻辑，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token function">genFor</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	这里我们对 <code>genFor</code> 不多做分析，后面单独分析，我们只要知道 <code>genFor</code> 是对 <code>AST</code> 元素节点中和 <code>for</code> 相关的一些属性的处理，然后再次调用 <code>genElement</code>  生成 <code>li AST</code> 元素节点的代码并拼接一些 <code>for</code> 相关的属性，最后返回这个拼接后的代码字符串。</p> <p>​	再次执行 <code>genElement</code> 函数的时候，由于在 <code>genFor</code> 中标记了已处理的标记，即 <code>el.forProcessed = true</code> ，所以这次执行 <code>genElement</code> 将不会在执行到 <code>genFor</code> 对应的 <code>if</code> 语句块，而是执行 <code>else</code> 语句。<code>else</code> 语句我们前面已经分析过了，此时又会执行 <code>else</code> 语句中的  <strong><code>genData</code></strong>  和 <strong><code>genChildren</code></strong> 函数，参数是 <code>li AST</code> 元素节点。</p> <ul><li><code>genData</code></li></ul> <p>​	<code>genData</code> 我们前面已经分析过了，这里需要强调一下，在处理 <code>li AST</code> 元素节点时，会执行下面的几个逻辑语句，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// key</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token string">&quot;key:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ref</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存ref到data属性上</span>
  data <span class="token operator">+=</span> <span class="token string">&quot;ref:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>refInFor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存refInFor到data属性上</span>
  data <span class="token operator">+=</span> <span class="token string">&quot;refInFor:true,&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// module data generation functions</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>dataGenFns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> state<span class="token punctuation">.</span>dataGenFns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// event handlers</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>​	这段代码中除了 <code>genHandlers</code> 逻辑我们没有分析，其他逻辑前面都分析过了这里就不重复讲解了。</p> <p>​	最后通过 <code>genData</code> 生成的<code>li AST</code> 元素节点的代码字符串，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>data <span class="token operator">=</span> <span class="token string">'{key:i,ref:&quot;i&quot;,refInFor:true,on:{&quot;click&quot;:function($event){return clickItem(index)}}}'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>genChildren</code></li></ul> <p>​	我们继续看看 <code>genChildren</code> 对<code>li AST</code> 元素节点的处理，这次执行 <code>genChildren</code> 获取到的子节点 <code>AST</code> 树为，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;expression&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_s(i)+\&quot;:\&quot;+_s(l)&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;tokens&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;@binding&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;@binding&quot;</span><span class="token operator">:</span> <span class="token string">&quot;l&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{{ i }}:{{ l }}&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">135</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;static&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>​	子节点 <code>AST</code> 树为文本节点，所以不会执行 <code>if</code> 语句而是执行一下代码，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> normalizationType <span class="token operator">=</span> checkSkip
<span class="token operator">?</span> <span class="token function">getNormalizationType</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> state<span class="token punctuation">.</span>maybeComponent<span class="token punctuation">)</span>
<span class="token operator">:</span> <span class="token number">0</span>
<span class="token keyword">const</span> gen <span class="token operator">=</span> altGenNode <span class="token operator">||</span> genNode

<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">gen</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
normalizationType <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>normalizationType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>​	首先通过 <code>checkSkip</code> 值来判断 <code>normalizationType(规范化类型)</code> 值的来源，在我们当前案例中，<code>checkSkip</code> 为 <code>true</code> ，所以会执行 <code>getNormalizationType</code> 函数，定义如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getNormalizationType</span> <span class="token punctuation">(</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>ASTNode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">maybeComponent</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">el</span><span class="token operator">:</span> ASTNode <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needsNormalization</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>el<span class="token punctuation">.</span>ifConditions <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">needsNormalization</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res <span class="token operator">=</span> <span class="token number">2</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>el<span class="token punctuation">.</span>ifConditions <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">maybeComponent</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>​	我们通过注视知道 <code>getNormalizationType</code> 的作用是确定子数组所需的规范化，规范化类型有一下三种：</p> <ul><li><code>0</code> : 不需要规范化</li> <li><code>1</code> : 需要简单的规范化（可能是1级深嵌套数组）</li> <li><code>2</code> : 需要完全规范化</li></ul> <p>​	我们再来看看 <code>getNormalizationType</code> 的执行逻辑，首先循环子节点，获取的每个子节点。</p> <p>​	然后第一个<code>if</code> 语句判断节点类型，如果节点类型为 <code>1</code>，则跳出本次循环，如果节点类型不为 <code>1</code>，则继续往下执行。</p> <p>​	接下来第二个<code>if</code> 语句块是对需要简单的规范化（可能是1级深嵌套数组）的节点的逻辑处理，将 <code>res</code> 赋值为 2，需要满足以下条件才会执行，<code>if</code> 语句块：</p> <ul><li>通过 <code>needsNormalization</code>  来判断节点上有 <code>v-for</code> 或标签名是 <code>template</code> 或 <code>slot</code></li> <li>或者节点是 <code>if</code> 块，并且块内元素有自定义组件的</li></ul> <p>​	第三个<code>if</code> 语句块是对需要完全规范化的节点的逻辑处理，将 <code>res</code> 赋值为 1，需要满足以下条件才会执行，<code>if</code> 语句块：</p> <ul><li><code>el</code> 是自定义组件</li> <li>或者节点是 <code>if</code> 块，并且块内元素有自定义组件的</li></ul> <p>​	我们再来看看 <code>needsNormalization</code> 的定义，如下：</p> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">needsNormalization</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> el<span class="token punctuation">.</span>for <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">||</span> el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'slot'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​	<code>needsNormalization</code> 很简单就是判断节点是否需要规范化，即满足一下条件：</p> <ul><li>节点存在 <code>for</code> 属性</li> <li>或者节点标签是 <code>template</code></li> <li>或者节点标签是 <code>slot</code></li></ul> <p>​	在我们当前案例中，子节点类型为 2，所以在通过 <code>getNormalizationType</code> 获取规范化类型时，执行的是第一个<code>if</code> 语句，得到的 <code>normalizationType</code> 为 0。</p> <p>​	我们回到 <code>genChildren</code>继续往下看，接下来是遍历子节点，调用 <code>genNode</code>  函数处理子节点。</p> <p>​	<code>genNode</code> 方法，根据不同的 <code>type</code> 执行具体的方法。在我们的例子中，<code>li AST</code> 元素节点的 <code>children</code> 是<code>type</code> 为 <code>2</code> 的表达式 <code>AST</code> 元素节点，那么会执行到 <code>genText(node)</code> 逻辑，最后 <code>genText</code> 生成的字符串为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string-property property">&quot;_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>li AST</code> 元素节点处理</li></ul> <p>​	我们再回到 <code>genChildren</code> 最后将遍历<code>li AST</code> 元素节点的子节点生成的字符串拼接起来，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string-property property">&quot;[_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))]&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	我们再回到 <code>genElement</code> 中，在 <code>else</code> 语句<code>li AST</code> 元素节点生成的字符串 <code>data</code>，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;{key:i,ref:&quot;</span>i<span class="token string">&quot;,refInFor:true,on:{&quot;</span>click<span class="token string">&quot;:function($event){return clickItem(index)}}}&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	然后拼接<code>li AST</code> 元素节点生成的字符串 <code>data</code> 和<code>li AST</code> 元素节点的子节点生成的字符串 <code>children</code> 赋值给变量 <code>code</code>，并返回 <code>code</code>，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;_c('li',{key:i,ref:&quot;</span>i<span class="token string">&quot;,refInFor:true,on:{&quot;</span>click<span class="token string">&quot;:function($event){return clickItem(index)}}},[_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))])&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	我们再回到 <code>genFor</code> 中，将节点的 <code>for</code> 属性的和 <code>code</code> 拼接起来，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;_l((list),function(l,i){return _c('li',{key:i,ref:&quot;</span>i<span class="token string">&quot;,refInFor:true,on:{&quot;</span>click<span class="token string">&quot;:function($event){return clickItem(index)}}},[_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))])})&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	至此<code>li AST</code> 元素节点处理生成的字符串已全部完成，接下来我们继续回到<code>ul AST</code> 元素节点的处理。</p> <ul><li><code>ul AST</code> 元素节点</li></ul> <p>​	我们再回到 <code>genChildren</code> ，这时处理的是<code>ul AST</code> 元素节点的子节点生成的字符串拼接起来，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;_l((list),function(l,i){return _c('li',{key:i,ref:&quot;</span>i<span class="token string">&quot;,refInFor:true,on:{&quot;</span>click<span class="token string">&quot;:function($event){return clickItem(index)}}},[_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))])}),0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	我们再回到 <code>genElement</code> ，这时对<code>ul AST</code> 元素节点的处理生成的字符串 <code>data</code> ，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;{staticClass:&quot;</span>list<span class="token string">&quot;,class:classObject}&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	生成的 <code>children</code> 字符串就是执行 <code>genChildren</code> 函数返回的结果，如上。</p> <p>​	然后拼接<code>ul AST</code> 元素节点生成的字符串 <code>data</code> 和<code>ul AST</code> 元素节点的子节点生成的字符串 <code>children</code> 赋值给变量 <code>code</code>，并返回 <code>code</code>，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;_c('ul',{staticClass:&quot;</span>list<span class="token string">&quot;,class:classObject},_l((list),function(l,i){return _c('li',{key:i,ref:&quot;</span>i<span class="token string">&quot;,refInFor:true,on:{&quot;</span>click<span class="token string">&quot;:function($event){return clickItem(index)}}},[_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))])}),0)&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	我们再回到 <code>genIfConditions</code> ，此函数中通过递归执行 <code>genIfConditions</code> 来处理 <code>v-if</code> 生成的 AST 树中对应的 <code>ifConditions</code> 数组中的所有节点，最终生成二元表达式，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;(isShow)?_c('ul',{staticClass:&quot;</span>list<span class="token string">&quot;,class:classObject},_l((list),function(l,i){return _c('li',{key:i,ref:&quot;</span>i<span class="token string">&quot;,refInFor:true,on:{&quot;</span>click<span class="token string">&quot;:function($event){return clickItem(index)}}},[_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))])}),0):_e()&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	我们再回到 <code>generate</code> 函数，将 <code>AST</code> 树生成的代码字符串，拼接成一个 <code>with</code> 语句如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;with(this){return (isShow)?_c('ul',{staticClass:&quot;</span>list<span class="token string">&quot;,class:classObject},_l((list),function(l,i){return _c('li',{key:i,ref:&quot;</span>i<span class="token string">&quot;,refInFor:true,on:{&quot;</span>click<span class="token string">&quot;:function($event){return clickItem(index)}}},[_v(_s(i)+&quot;</span><span class="token operator">:</span><span class="token string">&quot;+_s(l))])}),0):_e()}&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>​	至此模板生成的 <code>AST</code> 元素节点处理生成的字符串已全部分析完成。</p> <div class="custom-block danger"><p class="title"></p><p>说明：关于 <code>genFor</code>、<code>genHandlers</code> 、<code>genNode</code>、<code>genText</code>，我们会在下一小节单独分析。</p></div><h3 id="_4-6-genfor"><a href="#_4-6-genfor" class="header-anchor">#</a> 4.6 genFor</h3> <h3 id="_4-7-genhandlers"><a href="#_4-7-genhandlers" class="header-anchor">#</a> 4.7 genHandlers</h3> <h3 id="_4-8-gennode"><a href="#_4-8-gennode" class="header-anchor">#</a> 4.8 genNode</h3> <h3 id="_4-9-gentext"><a href="#_4-9-gentext" class="header-anchor">#</a> 4.9 genText</h3> <h3 id="_4-10-总结"><a href="#_4-10-总结" class="header-anchor">#</a> 4.10 总结</h3> <p><strong><code>generate</code>调用栈：</strong></p> <p><img src="https://lotosv2010.github.io/img/14.1.png" alt="调用栈"></p> <div class="custom-block danger"><p class="title"></p><p>说明：关于 <code>genDirectives</code> 、<code>genProps</code> 、<code>genScopedSlots</code>、<code>genInlineTemplate</code> 在我们案例中没有执行到，我们会在后面单独分析。</p></div><h2 id="_5-其他生成器"><a href="#_5-其他生成器" class="header-anchor">#</a> 5. 其他生成器</h2> <p>​	源码目录：<code>src/compiler/codegen/index.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_5-1-genstatic"><a href="#_5-1-genstatic" class="header-anchor">#</a> 5.1 genStatic</h3> <h3 id="_5-2-genonce"><a href="#_5-2-genonce" class="header-anchor">#</a> 5.2 genOnce</h3> <h3 id="_5-3-gendirectives"><a href="#_5-3-gendirectives" class="header-anchor">#</a> 5.3 genDirectives</h3> <div class="custom-block tip"><p class="title"></p><p>说明：关于 <code>directives</code>  可以移步到 <a href="https://cn.vuejs.org/v2/guide/custom-directive.html#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0" target="_blank" rel="noopener noreferrer"><strong>这里</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 学习。</p></div><h3 id="_5-4-genprops"><a href="#_5-4-genprops" class="header-anchor">#</a> 5.4 genProps</h3> <div class="custom-block tip"><p class="title"></p><p>说明：关于 <code>props</code> 和 <code>attrs</code>  的区别可以移步到 <a href="https://lotosv2010.github.io/view/vue/2018/10120800.html#_2-15-processattrs" target="_blank" rel="noopener noreferrer"><strong>这里</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 学习。</p></div><h3 id="_5-5-genslot"><a href="#_5-5-genslot" class="header-anchor">#</a> 5.5 genSlot</h3> <h3 id="_5-6-gencomponent"><a href="#_5-6-gencomponent" class="header-anchor">#</a> 5.6 genComponent</h3> <h3 id="_5-7-genscopedslots"><a href="#_5-7-genscopedslots" class="header-anchor">#</a> 5.7 genScopedSlots</h3> <h3 id="_5-8-geninlinetemplate"><a href="#_5-8-geninlinetemplate" class="header-anchor">#</a> 5.8 genInlineTemplate</h3> <h2 id="_6-参考"><a href="#_6-参考" class="header-anchor">#</a> 6. 参考</h2> <p><a href="https://www.cnblogs.com/zs-note/p/8675755.html" target="_blank" rel="noopener noreferrer">Vue源码学习（零）：内部原理解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.csdn.net/tcy83/article/details/89058191" target="_blank" rel="noopener noreferrer">VUE源码学习第九篇--编译(generate)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_1-概述" class="sidebar-link reco-side-_1-概述" data-v-b57cc07c>1. 概述</a></li><li class="level-2" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_2-generate" class="sidebar-link reco-side-_2-generate" data-v-b57cc07c>2. generate</a></li><li class="level-2" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_3-codegenstate" class="sidebar-link reco-side-_3-codegenstate" data-v-b57cc07c>3. CodegenState</a></li><li class="level-2" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-整体流程" class="sidebar-link reco-side-_4-整体流程" data-v-b57cc07c>4. 整体流程</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-1-genelement" class="sidebar-link reco-side-_4-1-genelement" data-v-b57cc07c>4.1 genElement</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-2-genif" class="sidebar-link reco-side-_4-2-genif" data-v-b57cc07c>4.2 genIf</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-3-genifconditions" class="sidebar-link reco-side-_4-3-genifconditions" data-v-b57cc07c>4.3 genIfConditions</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-4-gendata" class="sidebar-link reco-side-_4-4-gendata" data-v-b57cc07c>4.4 genData</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-5-genchildren" class="sidebar-link reco-side-_4-5-genchildren" data-v-b57cc07c>4.5 genChildren</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-6-genfor" class="sidebar-link reco-side-_4-6-genfor" data-v-b57cc07c>4.6 genFor</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-7-genhandlers" class="sidebar-link reco-side-_4-7-genhandlers" data-v-b57cc07c>4.7 genHandlers</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-8-gennode" class="sidebar-link reco-side-_4-8-gennode" data-v-b57cc07c>4.8 genNode</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-9-gentext" class="sidebar-link reco-side-_4-9-gentext" data-v-b57cc07c>4.9 genText</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_4-10-总结" class="sidebar-link reco-side-_4-10-总结" data-v-b57cc07c>4.10 总结</a></li><li class="level-2" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-其他生成器" class="sidebar-link reco-side-_5-其他生成器" data-v-b57cc07c>5. 其他生成器</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-1-genstatic" class="sidebar-link reco-side-_5-1-genstatic" data-v-b57cc07c>5.1 genStatic</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-2-genonce" class="sidebar-link reco-side-_5-2-genonce" data-v-b57cc07c>5.2 genOnce</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-3-gendirectives" class="sidebar-link reco-side-_5-3-gendirectives" data-v-b57cc07c>5.3 genDirectives</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-4-genprops" class="sidebar-link reco-side-_5-4-genprops" data-v-b57cc07c>5.4 genProps</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-5-genslot" class="sidebar-link reco-side-_5-5-genslot" data-v-b57cc07c>5.5 genSlot</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-6-gencomponent" class="sidebar-link reco-side-_5-6-gencomponent" data-v-b57cc07c>5.6 genComponent</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-7-genscopedslots" class="sidebar-link reco-side-_5-7-genscopedslots" data-v-b57cc07c>5.7 genScopedSlots</a></li><li class="level-3" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_5-8-geninlinetemplate" class="sidebar-link reco-side-_5-8-geninlinetemplate" data-v-b57cc07c>5.8 genInlineTemplate</a></li><li class="level-2" data-v-b57cc07c><a href="/view/vue/2018/10140800.html#_6-参考" class="sidebar-link reco-side-_6-参考" data-v-b57cc07c>6. 参考</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.ad2c5d61.js" defer></script><script src="/assets/js/4.82f582a9.js" defer></script><script src="/assets/js/1.72e48573.js" defer></script><script src="/assets/js/55.a7716bd5.js" defer></script>
  </body>
</html>
